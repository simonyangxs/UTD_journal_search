import streamlit as st
import streamlit.components.v1 as components
import urllib.parse
from datetime import datetime
import json
import time
# streamlit run journal_search_app.py
# ËÆæÁΩÆÈ°µÈù¢ÈÖçÁΩÆ
st.set_page_config(
    page_title="üìö UTD ÊúüÂàäÊêúÁ¥¢Â∑•ÂÖ∑",
    page_icon="üìö",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ÂÆö‰πâÊúüÂàäÊêúÁ¥¢ÈìæÊé•ÈÖçÁΩÆ
JOURNAL_CONFIGS = {
    # INFORMS ÊúüÂàä
    "Management Science (MS)": {
        "base_url": "https://pubsonline.informs.org/action/doSearch",
        "params": {
            "field1": "AllField",
            "text1": "",
            "publication[]": ["mnsc"],
            "publication": "",
            "BeforeYear": "",
            "BeforeMonth": "",
            "AfterMonth": "",
            "AfterYear": ""
        },
        "search_fields": ["AllField", "Title"],
        "supports_date": True
    },
    
    "Manufacturing & Service Operations Management (MSOM)": {
        "base_url": "https://pubsonline.informs.org/action/doSearch",
        "params": {
            "field1": "AllField",
            "text1": "",
            "publication[]": ["msom"],
            "publication": "",
            "BeforeYear": "",
            "BeforeMonth": "",
            "AfterMonth": "",
            "AfterYear": ""
        },
        "search_fields": ["AllField", "Title"],
        "supports_date": True
    },
    
    "Information Systems Research (ISR)": {
        "base_url": "https://pubsonline.informs.org/action/doSearch",
        "params": {
            "field1": "AllField",
            "text1": "",
            "publication[]": ["isre"],
            "publication": "",
            "BeforeYear": "",
            "BeforeMonth": "",
            "AfterMonth": "",
            "AfterYear": ""
        },
        "search_fields": ["AllField", "Title"],
        "supports_date": True
    },
    
    "Organization Science (OS)": {
        "base_url": "https://pubsonline.informs.org/action/doSearch",
        "params": {
            "field1": "AllField",
            "text1": "",
            "publication[]": ["orsc"],
            "publication": "",
            "BeforeYear": "",
            "BeforeMonth": "",
            "AfterMonth": "",
            "AfterYear": ""
        },
        "search_fields": ["AllField", "Title"],
        "supports_date": True
    },
    
    # ScienceDirect ÊúüÂàä
    "Journal of International Economics (JIE)": {
        "base_url": "https://www.sciencedirect.com/search",
        "params": {
            "qs": "",
            "title": "",
            "publicationTitles": "271695",
            "lastSelectedFacet": "years",
            "years": ""
        },
        "search_fields": ["Title", "AllField"],
        "supports_date": True
    },
    
    "Journal of Accounting and Economics (JAE)": {
        "base_url": "https://www.sciencedirect.com/search",
        "params": {
            "qs": "",
            "title": "",
            "publicationTitles": "271671",
            "lastSelectedFacet": "years",
            "years": ""
        },
        "search_fields": ["Title", "AllField"],
        "supports_date": True
    },
    
    "Journal of Financial Economics (JFE)": {
        "base_url": "https://www.sciencedirect.com/search",
        "params": {
            "qs": "",
            "title": "",
            "publicationTitles": "271661",
            "lastSelectedFacet": "years",
            "years": ""
        },
        "search_fields": ["Title", "AllField"],
        "supports_date": True
    },
    
    # MISQ
    "MIS Quarterly (MISQ)": {
        "base_url": "https://misq.umn.edu/catalogsearch/advanced/result/",
        "params": {
            "name": "",
            "description": "",
            "misq_year[from]": "",
            "misq_year[to]": "",
            "misq_author": "",
            "misq_volume": "",
            "misq_issue": ""
        },
        "search_fields": ["Title", "Abstract"],
        "supports_date": True
    },
    
    # AEA
    "American Economic Review (AER)": {
        "base_url": "https://www.aeaweb.org/journals/aer/search-results",
        "params": {
            "ArticleSearch[within][articletitle]": "",
            "ArticleSearch[within][articleabstract]": "",
            "ArticleSearch[within][authorlast]": "0",
            "JelClass[value]": "0",
            "journal": "1",
            "ArticleSearch[q]": ""
        },
        "search_fields": ["Title", "Abstract"],
        "supports_date": False
    },
    
    # Oxford ÊúüÂàä
    "Quarterly Journal of Economics (QJE)": {
        "base_url": "https://academic.oup.com/journals/search-results",
        "params": {
            "allJournals": "1",
            "f_JournalID": "3365",
            "fl_SiteID": "5567",
            "rg_ArticleDate": "",
            "dateFilterType": "",
            "noDateTypes": "",
            "rg_AllPublicationDates": "",
            "rg_VersionDate": "",
            "cqb": "",
            "qb": "",
            "page": "1"
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True
    },
    
    "Review of Financial Studies (RFS)": {
        "base_url": "https://academic.oup.com/journals/search-results",
        "params": {
            "allJournals": "1",
            "f_JournalID": "3372",
            "fl_SiteID": "5567",
            "rg_ArticleDate": "",
            "dateFilterType": "",
            "noDateTypes": "",
            "rg_AllPublicationDates": "",
            "rg_VersionDate": "",
            "cqb": "",
            "qb": "",
            "page": "1"
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True
    },
    
    "Review of Economic Studies (RES)": {
        "base_url": "https://academic.oup.com/journals/search-results",
        "params": {
            "allJournals": "1",
            "f_JournalID": "3369",
            "fl_SiteID": "5567",
            "rg_ArticleDate": "",
            "dateFilterType": "",
            "noDateTypes": "",
            "rg_AllPublicationDates": "",
            "rg_VersionDate": "",
            "cqb": "",
            "qb": "",
            "page": "1"
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True
    },
    
    # Wiley ÊúüÂàä
    "Journal of Finance (JF)": {
        "base_url": "https://onlinelibrary.wiley.com/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["15406261"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": ""
        },
        "search_fields": ["Title", "AllField", "Abstract"],
        "supports_date": True
    },
    
    "Journal of Accounting Research (JAR)": {
        "base_url": "https://onlinelibrary.wiley.com/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["1475679x"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": ""
        },
        "search_fields": ["Title", "AllField", "Abstract"],
        "supports_date": True
    },
    
    "Strategic Management Journal (SMJ)": {
        "base_url": "https://onlinelibrary.wiley.com/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["10970266"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": ""
        },
        "search_fields": ["Title", "AllField", "Abstract"],
        "supports_date": True
    },
    
    # Chicago
    "Journal of Political Economy (JPE)": {
        "base_url": "https://www.journals.uchicago.edu/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["jpe"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": ""
        },
        "search_fields": ["Title", "AllField"],
        "supports_date": True
    },
    
    # Sage ÊúüÂàä
    "Administrative Science Quarterly (ASQ)": {
        "base_url": "https://journals.sagepub.com/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["asqa"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": "",
            "access": ""
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True
    },
    
    "Production and Operations Management (POMS)": {
        "base_url": "https://journals.sagepub.com/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["paoa"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": "",
            "access": ""
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True
    },
    
    # AAA
    "The Accounting Review (AR)": {
        "base_url": "https://publications.aaahq.org/search-results",
        "params": {
            "q": "",
            "f_JournalDisplayName": "The+Accounting+Review",
            "fl_JournalID": "1000017",
            "fl_SiteID": "1",
            "rg_PublicationDate": "",
            "qb": "",
            "page": "1"
        },
        "search_fields": ["AllField", "Title", "Abstract"],
        "supports_date": True,
        "special_format": {
            "Abstract": "Abstract1",
            "Title": "Title1", 
            "AllField": "AllField1"
        }
    },
    
    # AOM
    "Academy of Management Journal (AMJ)": {
        "base_url": "https://journals.aom.org/action/doSearch",
        "params": {
            "field1": "Title",
            "text1": "",
            "publication[]": ["amj"],
            "publication": "",
            "Ppub": "",
            "AfterMonth": "",
            "AfterYear": "",
            "BeforeMonth": "",
            "BeforeYear": ""
        },
        "search_fields": ["Title", "AllField", "Abstract"],
        "supports_date": True
    }
}

def group_journals_by_website(selected_journals):
    """ÊåâÁΩëÁ´ôÂØπÊúüÂàäËøõË°åÂàÜÁªÑ"""
    website_groups = {}
    
    for journal in selected_journals:
        if journal not in JOURNAL_CONFIGS:
            continue
            
        base_url = JOURNAL_CONFIGS[journal]['base_url']
        website = base_url.split('/')[2]  # ÊèêÂèñÂüüÂêç
        
        if website not in website_groups:
            website_groups[website] = []
        website_groups[website].append(journal)
        
    return website_groups

def generate_combined_search_url(journals, search_term, search_field, start_year, end_year,
                               start_month=None, end_month=None):
    """‰∏∫Âêå‰∏ÄÁΩëÁ´ôÁöÑÊúüÂàäÁîüÊàêÊêúÁ¥¢URLÔºåÊîØÊåÅÂçï‰∏™ÊàñÂ§ö‰∏™ÊúüÂàäÔºåÊîØÊåÅÂπ¥ÊúàËåÉÂõ¥"""
    if not journals:
        return None
        
    # ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúüÂàä‰Ωú‰∏∫Ê®°Êùø
    template_journal = journals[0]
    config = JOURNAL_CONFIGS[template_journal]
    base_url = config['base_url']
    params = config['params'].copy()
    website = base_url.split('/')[2]
    
    # Ê£ÄÊü•ÊòØÂê¶ÊîØÊåÅÊó•ÊúüÁ≠õÈÄâ
    supports_date = config.get('supports_date', False)
    if not supports_date:
        start_year = end_year = start_month = end_month = None
    
    # Ê†πÊçÆÁΩëÁ´ôÁ±ªÂûãÂ§ÑÁêÜÂèÇÊï∞
    if 'informs.org' in website:
        # INFORMS ÊúüÂàä - ÊîØÊåÅÊó•ÊúüÂíåÊúà‰ªΩÁ≠õÈÄâ
        if len(journals) > 1:
            # Â§ö‰∏™ÊúüÂàäÂêàÂπ∂
            publications = []
            for journal in journals:
                if journal in JOURNAL_CONFIGS:
                    pub_list = JOURNAL_CONFIGS[journal]['params'].get('publication[]', [])
                    publications.extend(pub_list)
            params['publication[]'] = publications
        # Âçï‰∏™ÊúüÂàäÁõ¥Êé•‰ΩøÁî®Ê®°ÊùøÈÖçÁΩÆ‰∏≠ÁöÑ publication[]
        
        params['text1'] = search_term
        if search_field == "Title":
            params['field1'] = "Title"
        else:
            params['field1'] = "AllField"
        # Ê∑ªÂä†Êó•ÊúüÂíåÊúà‰ªΩÁ≠õÈÄâÊîØÊåÅ
        if start_year and end_year:
            params['AfterYear'] = start_year
            params['BeforeYear'] = end_year
            params['AfterMonth'] = str(start_month) if start_month else "1"
            params['BeforeMonth'] = str(end_month) if end_month else "12"
            
    elif 'sciencedirect.com' in website:
        # ScienceDirect ÊúüÂàä - ÊîØÊåÅ‰∏çÂêåÊêúÁ¥¢Â≠óÊÆµ
        if len(journals) > 1:
            # Â§ö‰∏™ÊúüÂàäÂêàÂπ∂
            publication_titles = []
            for journal in journals:
                if journal in JOURNAL_CONFIGS:
                    pub_titles = JOURNAL_CONFIGS[journal]['params'].get('publicationTitles', '')
                    if pub_titles:
                        publication_titles.append(pub_titles)
            params['publicationTitles'] = ','.join(publication_titles)
        
        # Ê†πÊçÆÊêúÁ¥¢Â≠óÊÆµËÆæÁΩÆÂèÇÊï∞
        if search_field == "Title":
            params['title'] = search_term
            # Ê∏ÖÁ©∫qsÂèÇÊï∞
            if 'qs' in params:
                del params['qs']
        else:  
            params['qs'] = search_term
            # Ê∏ÖÁ©∫titleÂèÇÊï∞
            if 'title' in params:
                del params['title']
                
        if start_year and end_year:
            years = ",".join([str(y) for y in range(int(start_year), int(end_year)+1)])
            params['years'] = years
            
    elif template_journal == "MIS Quarterly (MISQ)":
        # MISQ ÁâπÊÆäÂ§ÑÁêÜ
        if search_field == "Title":
            params["name"] = f'"{search_term}"'
        elif search_field == "Abstract":
            params["description"] = search_term
        if start_year:
            params["misq_year[from]"] = start_year
        if end_year:
            params["misq_year[to]"] = end_year
            
    elif template_journal == "American Economic Review (AER)":
        # AER ÁâπÊÆäÂ§ÑÁêÜ
        clean_search_term = search_term.replace('"', '').replace("'", "").replace(""", "").replace(""", "")
        params["ArticleSearch[q]"] = clean_search_term
        
        # Ê†πÊçÆÊêúÁ¥¢Â≠óÊÆµËÆæÁΩÆÁõ∏Â∫îÁöÑÊêúÁ¥¢ËåÉÂõ¥
        if search_field == "Title":
            params["ArticleSearch[within][articletitle]"] = "1"
            params["ArticleSearch[within][articleabstract]"] = "0"
        elif search_field == "Abstract":
            params["ArticleSearch[within][articletitle]"] = "0"
            params["ArticleSearch[within][articleabstract]"] = "1"
        else:
            params["ArticleSearch[within][articletitle]"] = "1"
            params["ArticleSearch[within][articleabstract]"] = "1"
            
    elif 'oup.com' in website:
        # Oxford ÊúüÂàä - ÊîØÊåÅÂπ¥ÊúàÁ≠õÈÄâÂíå‰∏çÂêåÊêúÁ¥¢Â≠óÊÆµ
        if len(journals) > 1:
            # Â§ö‰∏™ÊúüÂàäÂêàÂπ∂
            journal_ids = []
            for journal in journals:
                if journal in JOURNAL_CONFIGS:
                    j_id = JOURNAL_CONFIGS[journal]['params'].get('f_JournalID', '')
                    if j_id:
                        journal_ids.append(j_id)
            params['f_JournalID'] = 'AND'.join(journal_ids)
        # Âçï‰∏™ÊúüÂàäÁõ¥Êé•‰ΩøÁî®Ê®°ÊùøÈÖçÁΩÆ‰∏≠ÁöÑ f_JournalID
        
        if start_year and end_year:
            # ÈªòËÆ§‰ΩøÁî®Êúà‰ªΩÁöÑÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            start_date = f"{start_month:02d}%2f01%2f{start_year}" if start_month else f"01%2f01%2f{start_year}"
            
            # ËÆ°ÁÆóÁªìÊùüÊúà‰ªΩÁöÑÊúÄÂêé‰∏ÄÂ§©
            if end_month:
                if end_month in [1, 3, 5, 7, 8, 10, 12]:
                    last_day = 31
                elif end_month in [4, 6, 9, 11]:
                    last_day = 30
                else:  # 2Êúà
                    # ÁÆÄÂçïÂ§ÑÁêÜÈó∞Âπ¥Ôºå2ÊúàÊåâ28Â§©ÁÆó
                    last_day = 28
                end_date = f"{end_month:02d}%2f{last_day:02d}%2f{end_year}"
            else:
                end_date = f"12%2f31%2f{end_year}"
                
            date_range = f"{start_date}+TO+{end_date}"
            params['rg_ArticleDate'] = date_range
            params['dateFilterType'] = "range"
            params['noDateTypes'] = "true"
            params['rg_AllPublicationDates'] = date_range
            params['rg_VersionDate'] = date_range
        
        # Ê†πÊçÆÊêúÁ¥¢Â≠óÊÆµËÆæÁΩÆ‰∏çÂêåÁöÑfilterÂíåqbÂèÇÊï∞
        clean_search_term = search_term.replace('"', '').replace("'", "").replace(""", "").replace(""", "")

        if search_field == "Title":
            params['cqb'] = f'[{{"terms":[{{"filter":"Title","input":"{clean_search_term}","exactMatch":true}}]}}]'
            params['qb'] = f'{{"Title1-exact":"{clean_search_term}"}}'
        elif search_field == "Abstract":
            params['cqb'] = f'[{{"terms":[{{"filter":"ContentAbstract","input":"{clean_search_term}","exactMatch":true}}]}}]'
            params['qb'] = f'{{"ContentAbstract1-exact":"{clean_search_term}"}}'
        else:  
            params['cqb'] = f'[{{"terms":[{{"filter":"_text_","input":"{clean_search_term}","exactMatch":true}}]}}]'
            params['qb'] = f'{{"_text_1-exact":"{clean_search_term}"}}'
        
    elif 'wiley.com' in website:
        # Wiley ÊúüÂàä - ÊîØÊåÅÊúà‰ªΩÁ≠õÈÄâ
        if len(journals) > 1:
            # Â§ö‰∏™ÊúüÂàäÂêàÂπ∂
            publications = []
            for journal in journals:
                if journal in JOURNAL_CONFIGS:
                    pub_list = JOURNAL_CONFIGS[journal]['params'].get('publication[]', [])
                    publications.extend(pub_list)
            params['publication[]'] = publications
        # Âçï‰∏™ÊúüÂàäÁõ¥Êé•‰ΩøÁî®Ê®°ÊùøÈÖçÁΩÆ‰∏≠ÁöÑ publication[]
        
        params['text1'] = search_term.replace(" ", "+")
        if search_field == "Title":
            params['field1'] = "Title"
        elif search_field == "AllField":
            params['field1'] = "AllField"
        elif search_field == "Abstract":
            params['field1'] = "Abstract"
        else:
            params['field1'] = "AllField"
            
        if start_year and end_year:
            params['AfterYear'] = start_year
            params['BeforeYear'] = end_year
            params['AfterMonth'] = str(start_month) if start_month else "1"
            params['BeforeMonth'] = str(end_month) if end_month else "12"
            
    elif 'journals.uchicago.edu' in website:
        # Chicago ÊúüÂàä (JPE) - ÊîØÊåÅÊúà‰ªΩÁ≠õÈÄâ
        params['text1'] = search_term  # JPE‰∏çÈúÄË¶Å+Âè∑ÊõøÊç¢
        if search_field == "Title":
            params['field1'] = "Title"
        else:
            params['field1'] = "AllField"
            
        if start_year and end_year:
            params['AfterYear'] = start_year
            params['BeforeYear'] = end_year
            params['AfterMonth'] = str(start_month) if start_month else "1"
            params['BeforeMonth'] = str(end_month) if end_month else "12"
            
    elif 'sagepub.com' in website:
        # Sage ÊúüÂàä - ÊîØÊåÅÊúà‰ªΩÁ≠õÈÄâ
        if len(journals) > 1:
            # Â§ö‰∏™ÊúüÂàäÂêàÂπ∂
            publications = []
            for journal in journals:
                if journal in JOURNAL_CONFIGS:
                    pub_list = JOURNAL_CONFIGS[journal]['params'].get('publication[]', [])
                    publications.extend(pub_list)
            params['publication[]'] = publications
        # Âçï‰∏™ÊúüÂàäÁõ¥Êé•‰ΩøÁî®Ê®°ÊùøÈÖçÁΩÆ‰∏≠ÁöÑ publication[]
        
        params['text1'] = search_term
        # Ê†πÊçÆÊêúÁ¥¢Â≠óÊÆµËÆæÁΩÆfield1ÂèÇÊï∞
        if search_field == "Title":
            params['field1'] = "Title"
        elif search_field == "AllField":
            params['field1'] = "AllField" 
        elif search_field == "Abstract":
            params['field1'] = "Abstract"
        else:
            params['field1'] = "AllField"
            
        if start_year and end_year:
            params['AfterYear'] = start_year
            params['BeforeYear'] = end_year
            params['AfterMonth'] = str(start_month) if start_month else "1"
            params['BeforeMonth'] = str(end_month) if end_month else "12"
            
    elif 'publications.aaahq.org' in website:
        # AAA ÊúüÂàä (AR) - ÊîØÊåÅÁ≤æÁ°ÆÊó•ÊúüÁ≠õÈÄâÂíåÁâπÊÆäÊêúÁ¥¢Ê†ºÂºè
        config = JOURNAL_CONFIGS[template_journal]
        special_format = config.get("special_format", {})
        
        # Ê†πÊçÆÊêúÁ¥¢Â≠óÊÆµËÆæÁΩÆÁâπÊÆäÊ†ºÂºèÁöÑqbÂèÇÊï∞
        if search_field == "Title":
            field_name = special_format.get("Title", "Title1")
            params["qb"] = f'{{"{field_name}":"{search_term}"}}'
        elif search_field == "Abstract":
            field_name = special_format.get("Abstract", "Abstract1")
            params["qb"] = f'{{"{field_name}":"{search_term}"}}'
        else: 
            field_name = special_format.get("Anywhere", "Abstract1")
            params["qb"] = f'{{"{field_name}":"{search_term}"}}'
        
        # Ê∏ÖÁ©∫qÂèÇÊï∞Ôºå‰ΩøÁî®qbÂèÇÊï∞ËøõË°åÊêúÁ¥¢
        if "q" in params:
            params["q"] = ""
            
        if start_year and end_year:
            # ‰ΩøÁî®Âπ¥ÊúàËåÉÂõ¥ÔºåÈªòËÆ§‰ΩøÁî®Êúà‰ªΩÁöÑÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            start_date = f"{start_year}-{start_month:02d}-01" if start_month else f"{start_year}-01-01"
            
            # ËÆ°ÁÆóÁªìÊùüÊúà‰ªΩÁöÑÊúÄÂêé‰∏ÄÂ§©
            if end_month:
                if end_month in [1, 3, 5, 7, 8, 10, 12]:
                    last_day = 31
                elif end_month in [4, 6, 9, 11]:
                    last_day = 30
                else:  # 2Êúà
                    # ÁÆÄÂçïÂ§ÑÁêÜÈó∞Âπ¥Ôºå2ÊúàÊåâ28Â§©ÁÆó
                    last_day = 28
                end_date = f"{end_year}-{end_month:02d}-{last_day:02d}"
            else:
                end_date = f"{end_year}-12-31"
                
            date_range = f"{start_date}T00:00:00 TO {end_date}T23:59:59"
            params["rg_PublicationDate"] = date_range
            
    elif 'journals.aom.org' in website:
        # AOM ÊúüÂàä (AMJ) - ÊîØÊåÅÊúà‰ªΩÁ≠õÈÄâ
        search_term = search_term.replace(""", '"').replace(""", '"')
        params['text1'] = search_term.replace(" ", "+")
        if search_field == "Title":
            params['field1'] = "Title"
        elif search_field == "Abstract":
            params['field1'] = "Abstract"
        else:
            params['field1'] = "AllField"
            
        if start_year and end_year:
            params['AfterYear'] = start_year
            params['BeforeYear'] = end_year
            params['AfterMonth'] = str(start_month) if start_month else "1"
            params['BeforeMonth'] = str(end_month) if end_month else "12"
    
    # ÊûÑÂª∫ÊúÄÁªàURL
    url_params = []
    
    # ‰∏∫OxfordÊúüÂàä‰ΩøÁî®ÁâπÊÆäÁöÑURLÁºñÁ†ÅÊñπÂºè
    if 'oup.com' in website:
        for key, value in params.items():
            if isinstance(value, list):
                for item in value:
                    url_params.append(f"{key}={urllib.parse.quote(str(item))}")
            elif value:
                # ÂØπ‰∫éOxfordÊúüÂàäÔºåÊüê‰∫õÂèÇÊï∞ÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                if key in ['cqb', 'qb']:
                    # JSONÂèÇÊï∞ÈúÄË¶ÅÊ†áÂáÜURLÁºñÁ†Å
                    encoded_value = urllib.parse.quote(str(value))
                    url_params.append(f"{key}={encoded_value}")
                elif key in ['rg_ArticleDate', 'rg_AllPublicationDates', 'rg_VersionDate']:
                    # Êó•ÊúüÂèÇÊï∞Â∑≤ÁªèÈ¢ÑÁºñÁ†ÅÔºåÁõ¥Êé•‰ΩøÁî®
                    url_params.append(f"{key}={value}")
                else:
                    url_params.append(f"{key}={urllib.parse.quote(str(value))}")
    elif 'publications.aaahq.org' in website:
        # AAA ÊúüÂàäÈúÄË¶ÅÁâπÊÆäÁöÑURLÁºñÁ†ÅÊñπÂºè
        for key, value in params.items():
            if isinstance(value, list):
                for item in value:
                    url_params.append(f"{key}={urllib.parse.quote(str(item))}")
            elif value:
                if key == 'f_JournalDisplayName':
                    # ÊúüÂàäÂêçÁß∞‰ΩøÁî®+Âè∑ÊõøÊç¢Á©∫Ê†º
                    encoded_value = str(value).replace(' ', '+')
                    url_params.append(f"{key}={encoded_value}")
                elif key == 'qb':
                    # JSONÂèÇÊï∞‰ΩøÁî®Ê†áÂáÜURLÁºñÁ†Å
                    encoded_value = urllib.parse.quote(str(value))
                    url_params.append(f"{key}={encoded_value}")
                elif key == 'rg_PublicationDate':
                    # Êó•ÊúüÂèÇÊï∞‰øùÁïôÁ©∫Ê†º
                    encoded_value = urllib.parse.quote(str(value), safe=' :T-')
                    url_params.append(f"{key}={encoded_value}")
                else:
                    url_params.append(f"{key}={urllib.parse.quote(str(value))}")
    else:
        # ÂÖ∂‰ªñÁΩëÁ´ô‰ΩøÁî®Ê†áÂáÜÁºñÁ†Å
        for key, value in params.items():
            if isinstance(value, list):
                for item in value:
                    url_params.append(f"{key}={urllib.parse.quote(str(item))}")
            elif value:
                url_params.append(f"{key}={urllib.parse.quote(str(value))}")
    
    return f"{base_url}?{'&'.join(url_params)}"

def get_compatible_fields(selected_journals):
    """Ëé∑ÂèñÊâÄÈÄâÊúüÂàäÁöÑÂÖºÂÆπÊêúÁ¥¢Â≠óÊÆµ"""
    all_fields = set()
    for journal in selected_journals:
        if journal in JOURNAL_CONFIGS:
            all_fields.update(JOURNAL_CONFIGS[journal]['search_fields'])
    return list(all_fields)

# ‰∏ªÈ°µÈù¢
def main():
    st.title("üìö UTD ÊúüÂàäÊêúÁ¥¢Â∑•ÂÖ∑")
    st.markdown("---")
    
    # ‰æßËæπÊ†è - ÊúüÂàäÈÄâÊã©
    st.sidebar.header("üìã ÊúüÂàäÈÄâÊã©")
    
    # ÊåâÈ¢ÜÂüüÂàÜÁªÑÊúüÂàä
    journal_groups = {
        "Operations Management + Information System": [
            "Management Science (MS)",
            "Manufacturing & Service Operations Management (MSOM)", 
            "Production and Operations Management (POMS)",
            "Information Systems Research (ISR)",
            "MIS Quarterly (MISQ)"
        ],
        "Finance + Accounting": [
            "Journal of Finance (JF)",
            "Review of Financial Studies (RFS)",
            "Journal of Financial Economics (JFE)",
            "Journal of Accounting Research (JAR)",
            "Journal of Accounting and Economics (JAE)",
            "The Accounting Review (AR)"
        ],
        "Economics": [
            "American Economic Review (AER)",
            "Quarterly Journal of Economics (QJE)",
            "Journal of Political Economy (JPE)",
            "Journal of International Economics (JIE)",
            "Review of Economic Studies (RES)"
        ],
        "Management": [
            "Organization Science (OS)",
            "Strategic Management Journal (SMJ)",
            "Administrative Science Quarterly (ASQ)",
            "Academy of Management Journal (AMJ)"
        ],
    }
    
    # ÂÖ®ÈÄâ/Ê∏ÖÁ©∫ÊåâÈíÆ
    col1, col2 = st.sidebar.columns(2)
    select_all = col1.button("‚úÖ ÂÖ®ÈÄâ", key="select_all")
    clear_all = col2.button("‚ùå Ê∏ÖÁ©∫", key="clear_all")
    
    # ÂàùÂßãÂåñ‰ºöËØùÁä∂ÊÄÅ
    if 'selected_journals' not in st.session_state:
        st.session_state.selected_journals = []
    
    # Â§ÑÁêÜÂÖ®ÈÄâ/Ê∏ÖÁ©∫ÊåâÈíÆ
    if select_all:
        st.session_state.selected_journals = [j for group in journal_groups.values() for j in group if j in JOURNAL_CONFIGS]
    
    if clear_all:
        st.session_state.selected_journals = []
    
    # ÊúüÂàäÂ§çÈÄâÊ°Ü
    selected_journals = []
    for group_name, journals in journal_groups.items():
        st.sidebar.subheader(group_name)
        for journal in journals:
            if journal in JOURNAL_CONFIGS:
                if st.sidebar.checkbox(
                    journal,
                    value=journal in st.session_state.selected_journals,
                    key=f"checkbox_{journal}"
                ):
                    selected_journals.append(journal)
    
    # Êõ¥Êñ∞‰ºöËØùÁä∂ÊÄÅ
    st.session_state.selected_journals = selected_journals
    
    # ‰∏ªÂå∫Âüü - ÊêúÁ¥¢ËÆæÁΩÆ
    st.header("üîç ÊêúÁ¥¢ËÆæÁΩÆ")
    
    # Á¨¨‰∏ÄË°åÔºöÊêúÁ¥¢ÂÖ≥ÈîÆËØçÂíåÊêúÁ¥¢Â≠óÊÆµ
    col1, col2 = st.columns([3, 1])
    with col1:
        # ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
        search_term = st.text_area(
            "ÊêúÁ¥¢ÂÖ≥ÈîÆËØç",
            placeholder="ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç...",
            height=80
        )
    
    with col2:
        # ÊêúÁ¥¢Â≠óÊÆµÈÄâÊã©
        if selected_journals:
            compatible_fields = get_compatible_fields(selected_journals)
            search_field = st.selectbox(
                "ÊêúÁ¥¢Â≠óÊÆµ",
                options=compatible_fields,
                index=0 if compatible_fields else 0
            )
        else:
            search_field = st.selectbox(
                "ÊêúÁ¥¢Â≠óÊÆµ",
                options=["AllField", "Title", "Abstract"],
                index=0
            )
    
    # Á¨¨‰∫åË°åÔºöÊó∂Èó¥ËåÉÂõ¥
    st.header("üìÖ Êó∂Èó¥ËåÉÂõ¥")
    current_year = datetime.now().year
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        # Ëµ∑ÂßãÂπ¥‰ªΩ
        start_year = st.number_input(
            "Ëµ∑ÂßãÂπ¥‰ªΩ",
            min_value=1900,
            max_value=current_year + 10,
            value=current_year - 5
        )
    
    with col2:
        # Ëµ∑ÂßãÊúà‰ªΩ
        start_month = st.selectbox(
            "Ëµ∑ÂßãÊúà‰ªΩ",
            options=list(range(1, 13)),
            format_func=lambda x: f"{x}Êúà",
            index=0
        )
    
    with col3:
        # ÁªìÊùüÂπ¥‰ªΩ
        end_year = st.number_input(
            "ÁªìÊùüÂπ¥‰ªΩ",
            min_value=1900,
            max_value=current_year + 10,
            value=current_year
        )
    
    with col4:
        # ÁªìÊùüÊúà‰ªΩ
        end_month = st.selectbox(
            "ÁªìÊùüÊúà‰ªΩ",
            options=list(range(1, 13)),
            format_func=lambda x: f"{x}Êúà",
            index=11
        )
    
    # ÊòæÁ§∫Â∑≤ÈÄâÊã©ÁöÑÊúüÂàä
    if selected_journals:
        st.info(f"Â∑≤ÈÄâÊã© {len(selected_journals)} ‰∏™ÊúüÂàä: {', '.join([j.split(' (')[0] for j in selected_journals])}")
    else:
        st.warning("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊúüÂàä")
    
    st.markdown("---")
    
    # ÊêúÁ¥¢ÊåâÈíÆ
    if st.button("üîç ÁîüÊàêÊêúÁ¥¢ÈìæÊé•", type="primary", disabled=not selected_journals or not search_term):
        if not selected_journals:
            st.error("‚ö†Ô∏è ËØ∑Ëá≥Â∞ëÂãæÈÄâ‰∏Ä‰∏™ÊúüÂàäÔºÅ")
        elif not search_term.strip():
            st.error("‚ö†Ô∏è ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºÅ")
        else:
            # ÊòæÁ§∫ÊêúÁ¥¢‰ø°ÊÅØ
            date_info = f"{start_year}Âπ¥{start_month}Êúà Ëá≥ {end_year}Âπ¥{end_month}Êúà"
            st.success(f"üöÄ ÂºÄÂßã‰∏∫ {len(selected_journals)} ‰∏™ÊúüÂàäÁîüÊàêÊêúÁ¥¢URL")
            st.info(f"üìÖ Êó∂Èó¥ËåÉÂõ¥: {date_info}")
            
            # ÊåâÁΩëÁ´ôÂàÜÁªÑÊúüÂàä
            website_groups = group_journals_by_website(selected_journals)
            
            urls_info = []
            all_urls = []
            
            for website, journals in website_groups.items():
                st.write(f"**üì° Â§ÑÁêÜÁΩëÁ´ô: {website}**")
                
                # Áªü‰∏Ä‰ΩøÁî®ÂêàÂπ∂ÊêúÁ¥¢ÈÄªËæë
                combined_url = generate_combined_search_url(
                    journals, search_term.strip(), search_field, start_year, end_year,
                    start_month, end_month
                )
                
                if combined_url:
                    if len(journals) == 1:
                        # Âçï‰∏™ÊúüÂàäÊòæÁ§∫
                        journal_display_name = journals[0].split(' (')[0]
                        urls_info.append(f"**üîó {journal_display_name}:**\n{combined_url}")
                    else:
                        # Â§ö‰∏™ÊúüÂàäÊòæÁ§∫
                        journal_names = ", ".join([j.split(' (')[0] for j in journals])
                        urls_info.append(f"**üîó ÂêàÂπ∂ÊêúÁ¥¢ ({journal_names}):**\n{combined_url}")
                    all_urls.append(combined_url)
            
            if all_urls:
                 st.success(f"‚úÖ ÁîüÊàê‰∫Ü {len(all_urls)} ‰∏™ÊêúÁ¥¢URLÔºÅ")
                 
                 # ÊòæÁ§∫ÁîüÊàêÁöÑURLs
                 st.header("üìã ÁîüÊàêÁöÑÊêúÁ¥¢ÈìæÊé•")
                 for i, url_info in enumerate(urls_info):
                     with st.expander(f"ÊêúÁ¥¢ÈìæÊé• {i+1}", expanded=True):
                         lines = url_info.split('\n')
                         st.markdown(lines[0])
                         if len(lines) > 1:
                             st.code(lines[1], language='text')
                 
                 # Ëá™Âä®ÊâìÂºÄÊâÄÊúâÊêúÁ¥¢È°µÈù¢
                 st.info("üöÄ Ê≠£Âú®Ëá™Âä®ÊâìÂºÄÊâÄÊúâÊêúÁ¥¢È°µÈù¢...")
                 
                 # ÁîüÊàêJavaScript‰ª£Á†ÅÊù•ÊâìÂºÄÊâÄÊúâÈìæÊé•
                 js_code = """
                 <script>
                 // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
                 window.onload = function() {
                     var urls = %s;
                     var delay = 500; // ÊØè‰∏™È°µÈù¢Èó¥Èöî500ÊØ´ÁßíÊâìÂºÄ
                     
                     urls.forEach(function(url, index) {
                         setTimeout(function() {
                             window.open(url, '_blank');
                         }, index * delay);
                     });
                 };
                 </script>
                 """ % str(all_urls).replace("'", '"')
                 
                 # ÊâßË°åJavaScript
                 components.html(js_code, height=0)
                 
                 # ‰∏ÄÈîÆÂ§çÂà∂ÊâÄÊúâÈìæÊé•
                 all_urls_text = "\n\n".join([url_info.replace('**', '').replace('üîó ', '') for url_info in urls_info])
                 if st.button("üìã Â§çÂà∂ÊâÄÊúâÈìæÊé•"):
                     st.code(all_urls_text, language='text')
                     st.info("ÈìæÊé•Â∑≤ÊòæÁ§∫Âú®‰∏äÊñπ‰ª£Á†ÅÊ°Ü‰∏≠ÔºåËØ∑ÊâãÂä®Â§çÂà∂")
                    
            else:
                st.error("‚ùå URLÁîüÊàêÂ§±Ë¥•ÔºÅ")

if __name__ == "__main__":
    main()